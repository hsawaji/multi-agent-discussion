# システムリアーキテクチャ技術選定 - 議論結果レポート

**作成日**: 2025年12月15日
**議題**: 10年以上運用されているPHP + CakePHPシステムのリアーキテクチャにおける技術選定

---

## 1. 結論

### 言語・技術スタック
**PHP 8.x + Laravel を基本線とする**（ただし、真因分析完了後に最終決定）

### 開発手法・設計理論
**モジュラーモノリス + クリーンアーキテクチャ + DDD（ドメイン駆動設計）**

### 移行戦略
**ストラングラーフィグパターンによる段階的移行**

---

## 2. 結論に対する簡単な説明

リアーキテクチャプロジェクトの約70%が失敗するという現実を踏まえ、最もリスクの低い選択を行った。「PHPが悪い」という仮説に基づく安易な言語変更ではなく、まず開発速度低下の真因を分析し、その結果に基づいて判断することを推奨する。PHP 8.xとLaravelの組み合わせは、既存チームのスキルを活かしつつモダンな設計を導入できる現実的な選択肢である。ユーザー視点では「何も変わっていないと感じること」が成功の定義であり、段階的移行によりサービスの安定性を維持しながら改善を進める。

---

## 3. 背景に記載がない前提

議論の中で以下の前提を置いて検討を行った：

| 前提事項 | 想定した内容 |
|----------|--------------|
| チーム構成 | 現在のチームはPHPエンジニアが中心で、他言語（Go, Kotlin等）の経験者は少数 |
| 採用市場 | PHPエンジニアは採用可能だが、Go/Rustエンジニアは競争が激しい |
| 予算制約 | 無制限ではなく、コスト効率を考慮する必要がある |
| 移行中の開発 | リアーキテクチャ中も新機能開発を継続する必要がある |
| インフラ環境 | クラウド環境（AWS/GCP等）での運用を想定 |
| ビジネス成長 | 会員数は今後も増加傾向、スケーラビリティが重要 |
| 規制要件 | 健康データを扱うため、セキュリティ・プライバシー要件が厳格 |

---

## 4. どのようなことが検討されたかの詳細

### 4.1 言語・技術スタックの検討

#### 検討された選択肢

| 選択肢 | メリット | デメリット | 支持エージェント |
|--------|----------|------------|------------------|
| **Go + TypeScript** | 高パフォーマンス、シンプル、年収トップ | 学習コスト、既存スキル活用困難 | ideator |
| **Kotlin + Spring Boot** | null安全性、エンタープライズ実績 | JVM移行コスト、複雑性 | ideator, researcher |
| **PHP 8.x + Laravel** | 移行コスト最小、既存スキル活用 | 「変革感」が薄い | critic, pragmatist, advocate |
| **Rust** | 最高性能、メモリ安全 | 学習曲線が急、採用困難 | (検討のみ) |

#### 決定のポイント

1. **criticの指摘**: 「PHPが悪い」は仮説に過ぎない。複雑さの原因が設計にあるなら言語変更は解決策にならない
2. **失敗率70%の教訓**: 正しい診断なしの処方箋は危険
3. **pragmatistの提案**: まず「開発速度を落としている原因Top5」をヒアリングすべき

### 4.2 アーキテクチャの検討

#### 検討された選択肢

| 選択肢 | メリット | デメリット | 採用判断 |
|--------|----------|------------|----------|
| **マイクロサービス** | 独立デプロイ、スケーラビリティ | 分散システムの複雑さ、運用コスト増 | **不採用** |
| **モジュラーモノリス** | 境界明確化、運用シンプル | 完全な独立性はない | **採用** |
| **クリーンアーキテクチャ** | ビジネスロジック隔離、テスタビリティ | 初期実装コスト | **採用** |
| **DDD** | ドメイン理解の深化、保守性向上 | 学習コスト高 | **採用**（段階的に） |

#### criticからの重要な警告

- マイクロサービスは「分散システムの複雑さ」をもたらす
- 900万会員規模でも、モジュラーモノリスで十分対応可能
- DDDは「導入する」ものではなく、ドメイン理解の結果として現れるもの

### 4.3 移行戦略の検討

#### 検討された選択肢

| 選択肢 | リスク | 期間 | 採用判断 |
|--------|--------|------|----------|
| **ビッグバン移行** | 極めて高い | 短い（見かけ上） | **不採用**（全員反対） |
| **ストラングラーフィグパターン** | 低い | 長い（2-3年） | **採用**（全員合意） |
| **並行稼働** | 中程度 | 中程度 | **採用**（ストラングラーと併用） |

#### researcherの調査結果

**成功事例**:
- Yahoo!ショッピングクーポン: PHP → Java/Spring Boot + DDD
- ナイル（Appliv）: PHP → Scala + マイクロサービス

**失敗事例**:
- 江崎グリコ: SAP移行で主力商品の出荷停止
- 京都市: 基幹システム刷新で約100億円損失

**成功の共通点**: 段階的移行、十分な準備期間、経営層の関与

### 4.4 ユーザー視点での検討

advocateからの重要な指摘:

| ユーザーの関心事 | 技術選定への影響 |
|------------------|------------------|
| **速さ** | パフォーマンス劣化は絶対に許されない |
| **安定性** | ダウンタイムは離脱のきっかけになる |
| **使いやすさ** | UIや操作感を極力変えない |
| **データの安全** | 10年分の健康記録は絶対に守る |

**成功の定義**: 「ユーザーが何も変わっていないと感じること」

### 4.5 実行計画

#### フェーズ構成

```
フェーズ0: 真因分析と準備（3ヶ月）
    |
フェーズ1: 境界定義と設計（2ヶ月）
    |
フェーズ2: パイロット移行（6ヶ月）
    |
フェーズ3: 段階的拡大（12-18ヶ月）
```

#### フェーズ0の詳細（最初の一歩）

| 実施事項 | 期間 | 成果物 |
|----------|------|--------|
| 開発チームへのヒアリング（Top5原因） | 2週間 | 原因リスト |
| コードベースの複雑性分析 | 2週間 | 分析レポート |
| ボトルネック箇所の特定 | 2週間 | 改善優先度リスト |
| チームスキルマップ作成 | 1週間 | スキルマップ |
| 撤退ラインの定義 | 1週間 | 判断基準書 |
| 技術選定の最終決定 | 2週間 | 決定文書 |

---

## 5. どのエージェントが使われたか

本議論では、以下の6つのエージェントを使用して多角的な検討を行った：

| エージェント | 役割 | 主な貢献 |
|--------------|------|----------|
| **ideator** | アイデア出し | 技術選択肢の洗い出し、3つの推奨パターンの提案 |
| **critic** | 批判的分析 | リスクの指摘、「PHPが悪い」仮説への疑問提起 |
| **pragmatist** | 実務的計画 | 段階的移行計画、最初の一歩の具体化 |
| **advocate** | ユーザー視点 | 成功の定義「ユーザーが変化を感じないこと」 |
| **researcher** | 市場調査 | 成功/失敗事例の収集、技術トレンドの調査 |
| **facilitator** | 意思決定統合 | 各意見の統合、最終決定の文書化 |

### エージェント間の対立と収束

**対立点**: 言語変更の要否
- ideator: 「長期的な技術的優位性を考えると言語変更も選択肢」
- critic: 「まずPHPリファクタリングで解決できないか検証すべき」

**収束点**: 真因分析を先行し、その結果に基づいて判断
- 全員が「ビッグバン移行は不採用」で合意
- 全員が「ストラングラーフィグパターン採用」で合意
- 全員が「ユーザー影響ゼロが成功の定義」で合意

### エージェント間の対話フロー

```
並列実行（5エージェント）
   |
   +-- ideator: 技術選択肢とパターンを提案
   |
   +-- critic: リスクと落とし穴を指摘
   |
   +-- pragmatist: 実行計画を提示
   |
   +-- advocate: ユーザー視点で評価
   |
   +-- researcher: 事例とトレンドを調査
   |
   v
facilitator: 意見を統合して最終決定
```

---

## 6. 見直し条件

以下の状況が発生した場合、本決定を再検討する：

1. **真因分析でPHP自体の制約が主因と判明した場合** → 言語変更を再検討
2. **パイロット移行で予期せぬ問題が発生した場合** → 撤退ラインに基づき判断
3. **採用市場の変化でPHPエンジニア確保が困難になった場合** → 言語変更を検討
4. **ビジネス要件の変化で大幅なスケールアップが必要になった場合** → アーキテクチャを再検討

---

## 7. 最終メッセージ

本決定は「急がば回れ」の精神に基づいている。

リアーキテクチャの70%が失敗する現実を踏まえ、**最もリスクの低い選択**をした。これは「変革しない」という意味ではない。**正しい診断に基づいた、根拠ある変革**を目指すものである。

10年動いているシステムは「醜い」のではなく「生き残った」のだ。その価値を認めた上で、段階的かつ慎重に改善を進めることを推奨する。

---

## 参考: 主要な情報源

- Yahoo! JAPAN Tech Blog: DDDによるクーポンシステム刷新事例
- CodeZine: ナイルのPHP→Scala移行事例
- ダイヤモンド・オンライン: グリコのシステム障害事例
- paiza: プログラミング言語別年収ランキング2024
- Martin Fowler: ストラングラーフィグパターン
