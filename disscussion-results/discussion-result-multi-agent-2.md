# システムリアーキテクチャ技術選定 - 意思決定ドキュメント

**作成日**: 2025年12月15日
**対象**: 10年以上運用されている健康管理サービス（会員数900万人）のリアーキテクチャ

---

## 1. 結論

### 言語・技術スタック
**Laravel 11 + Vue.js 3（TypeScript）** を採用する

### 開発手法・設計理論
**モジュラーモノリス + 戦術的DDD（ドメイン駆動設計）** を採用する

### 移行戦略
**ストラングラーパターン（3年計画）** で段階的に移行する

---

## 2. 結論に対する簡単な説明

10年間900万人を支えてきたPHP/CakePHPサービスのリアーキテクチャにおいて、「確実に完遂できる移行」を最優先とし、Laravel + モジュラーモノリスという保守的選択を行いました。既存PHPチームの即戦力化、豊富な人材プール、安定したエコシステムを活かしつつ、DDDによる設計刷新で本質的な保守性向上を図ります。GoやKotlinへの言語変更は学習コストと人材確保リスクが高く、900万人規模のサービスで「学習しながら移行」は危険と判断しました。ストラングラーパターンにより「ユーザーに気づかせない移行」を実現し、データ消失ゼロ・サービス中断ゼロを保証します。

---

## 3. 背景に記載がない前提

本意思決定は、以下の前提条件を想定しています：

| 前提 | 想定内容 |
|------|----------|
| 既存チーム構成 | PHPエンジニアが主体（他言語経験者は少数） |
| 現在のPHPバージョン | PHP 7.x系（8.x未満の可能性） |
| インフラ環境 | オンプレミスまたはIaaS（コンテナ化未実施） |
| テストカバレッジ | 低い（ユニットテストが不十分な可能性） |
| CI/CD成熟度 | 基本的な自動デプロイはあるが、高度な自動化は未実施 |
| 経営層のコミットメント | 3年の長期投資が承認可能 |
| 採用計画 | 追加人員の確保が可能 |

---

## 4. どのようなことが検討されたかの詳細

### 4.1 言語・技術スタックの検討

#### 検討された選択肢

| 選択肢 | メリット | デメリット | 最終判断 |
|--------|----------|-----------|----------|
| **Laravel（採用）** | 移行コスト最小、即戦力チーム、豊富な人材 | 最新技術での差別化困難、パフォーマンス限界 | ✅ 採用 |
| **Go** | 圧倒的パフォーマンス、並行処理、DevOps親和性 | 学習コスト6ヶ月〜1年、人材希少、パラダイム変更大 | ❌ 不採用 |
| **Kotlin/Spring Boot** | 型安全性、JVMエコシステム、大企業実績 | JVM運用知識必要、人材最希少、エコシステム変更大 | ❌ 不採用 |
| **TypeScript/Node.js** | フルスタック統一、JSON親和性、採用市場良好 | シングルスレッド制約、エコシステム不安定 | ❌ 不採用（バックエンドとして） |

#### 採用理由の詳細

1. **チームの即戦力化**: 既存PHPエンジニアが即座に貢献可能。新言語習得による6ヶ月〜1年のロスを回避
2. **採用市場の現実**: Go/Kotlinエンジニアは希少で採用コスト高。Laravel人材は豊富で3年計画の人材確保見通しが立つ
3. **リスク最小化**: 900万人サービスで「学習しながら移行」は高リスク。確実な完遂を優先
4. **将来の拡張性**: Vue.js 3 + TypeScriptでフロントエンドは近代化。将来的にバックエンドの一部をGoに移行する余地を残す

### 4.2 設計手法の検討

#### 検討された選択肢

| 選択肢 | メリット | デメリット | 最終判断 |
|--------|----------|-----------|----------|
| **モジュラーモノリス（採用）** | 運用シンプル、段階的分離可能、チーム学習に最適 | スケーラビリティ限界、技術選択制限 | ✅ 採用 |
| **マイクロサービス** | スケーラビリティ柔軟、技術選択自由、チーム独立性 | 分散システム複雑性、運用難易度高、データ整合性問題 | ❌ 不採用（初期段階） |
| **フルDDD導入** | ビジネス要件変更に強い、ユビキタス言語確立 | 形骸化リスク、学習コスト高、過剰設計の危険 | △ 戦術的DDDに限定 |
| **クリーンアーキテクチャ** | テスト容易性、技術的柔軟性、長寿命コード | 過度な抽象化、ボイラープレート増加 | △ 簡易版を採用 |

#### 採用理由の詳細

1. **criticの警告採用**: 「モノリスを上手く作れないチームにマイクロサービスは無理」
2. **DDD形骸化対策**: 戦術的DDDに限定（ユビキタス言語、境界づけられたコンテキスト、エンティティ・値オブジェクト）
3. **クリーンアーキテクチャ簡易版**: 完全な4層ではなく3層（Presentation / Application / Domain+Infrastructure）

### 4.3 移行戦略の検討

#### 検討された選択肢

| 選択肢 | メリット | デメリット | 最終判断 |
|--------|----------|-----------|----------|
| **ストラングラーパターン（採用）** | リスク分散、段階的リリース、ロールバック容易 | 移行期間長期化、並行運用の複雑性 | ✅ 採用 |
| **ビッグバンリプレース** | 一度で完了、並行運用不要 | 極大リスク、全面停止の可能性、ロールバック困難 | ❌ 不採用 |

#### 3年計画の詳細

```
Year 1: 基盤整備フェーズ
├── Q1-Q2: PHP 8.3アップグレード、Docker化
├── Q3: CI/CD整備、テスト基盤構築
└── Q4: APIゲートウェイ導入、認証基盤統一

Year 2: 段階的移行フェーズ
├── Q1-Q2: 新規機能はLaravelで開発
├── Q3: 低リスク機能から移行開始（設定系、通知系）
└── Q4: 中リスク機能の移行（レポート系）

Year 3: コア移行フェーズ
├── Q1-Q2: 記録機能の移行（最重要・最慎重）
├── Q3: 健診連携機能の移行（繁忙期を避ける）
└── Q4: 旧システム廃止、最終統合
```

### 4.4 ユーザー影響の検討

| 要件 | 対応策 |
|------|--------|
| データ消失ゼロ | デュアルライト方式、定期整合性チェック、完全バックアップ |
| 習慣中断なし | 機能単位の段階移行、ロールバック即時可能、機能フラグ活用 |
| ゼロダウンタイム | Blue-Greenデプロイ、カナリアリリース |
| 健診繁忙期回避 | 3〜5月、9〜11月の大規模作業禁止 |

### 4.5 リスク分析

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| データ不整合 | 極大 | 中 | 双方向同期、定期整合性チェック |
| 性能劣化 | 大 | 中 | 負荷テスト必須、カナリアリリース |
| チーム疲弊 | 大 | 高 | 3年計画で余裕確保、定期的な振り返り |
| スコープクリープ | 大 | 高 | 移行中の仕様変更は原則禁止 |
| 旧システムの緊急改修 | 中 | 高 | 最低限のメンテ体制を残す |

---

## 5. どのエージェントが使われたか

本意思決定には、以下の6つの専門エージェントが参加しました：

### 5.1 researcher（市場調査エージェント）

**役割**: 最新の技術トレンドと移行事例の調査

**主な貢献**:
- 2024-2025年の大規模Webサービス技術トレンド調査
- PHPからの移行事例収集（Yahoo!カレンダー、LIFULL HOME'S、ZOZOTOWN等）
- 各技術スタック（Go, Kotlin, TypeScript）の採用企業と事例
- ストラングラーパターンの実践事例（ZOZOTOWN API Gateway）

### 5.2 critic（批判的分析エージェント）

**役割**: リスクと落とし穴の徹底的な指摘

**主な貢献**:
- 「リアーキテクチャ自体が最大のリスク」という核心的警告
- 各技術選択の致命的問題点の指摘
- 「同じ言語だから楽は幻想」という重要な視点
- 「モノリスを上手く作れないチームにマイクロサービスは無理」という金言
- DDD形骸化、クリーンアーキテクチャ過剰設計のリスク指摘

### 5.3 pragmatist（実践的分析エージェント）

**役割**: 実行可能な計画の策定

**主な貢献**:
- Laravel + Vue.jsという現実的な技術選定
- ストラングラーパターン一択という明確な方針
- 3年計画の具体的なタイムライン提示
- 最初に着手すべき領域の特定（基盤整備）
- チーム疲弊・スコープクリープへの対策

### 5.4 advocate（ユーザー視点エージェント）

**役割**: エンドユーザー・開発者・ステークホルダーの視点代弁

**主な貢献**:
- 900万人ユーザーの最重要事項特定（データ消失ゼロ、習慣中断なし）
- 「ユーザーに気づかせない移行」という目標設定
- 健診繁忙期の作業禁止という必須条件
- 長期ユーザー・日常的ユーザー・高齢ユーザー等、異なるユーザー層の懸念分析

### 5.5 optimist（ポジティブ面分析エージェント）

**役割**: 機会とメリットの発見

**主な貢献**:
- リアーキテクチャがもたらすチャンス（技術的負債一掃、開発速度向上、採用競争力強化）
- 各技術選択の強みの整理
- モジュラーモノリスが現状に最適解という提言
- 組織にもたらす長期的価値の可視化

### 5.6 facilitator（意思決定統合エージェント）

**役割**: 全エージェントの意見統合と最終決定

**主な貢献**:
- 5つのエージェントの意見の合意点・対立点の整理
- 最終的な技術選定の決定と根拠の明示
- トレードオフの明確化
- 各アドバイザーからの懸念への対応策
- 撤退条件と見直し条件の設定

---

## 6. 補足：見直し条件

以下の状況が発生した場合、技術選定を再検討します：

1. **Year 1終了時点でLaravelのパフォーマンス限界が明確になった場合** → 高負荷部分のみGoでのリプレースを検討
2. **採用市場でPHP/Laravel人材の確保が困難になった場合** → TypeScript/Node.jsへの部分移行を検討
3. **モジュラーモノリスで境界が明確になり、分離メリットが大きいドメインが特定できた場合** → マイクロサービス化を検討

---

## 7. 撤退条件

以下のいずれかが発生した場合、計画を見直します：

- 移行後の障害発生率が旧システムの2倍を超える
- チーム離職率が20%を超える
- 予算超過が50%を超える
- ユーザーからの重大クレームが発生

---

**作成**: Claude Code マルチエージェント意思決定システム
**参加エージェント**: researcher, critic, pragmatist, advocate, optimist, facilitator
