# システムリアーキテクチャ技術選定 - 議論結果レポート

**作成日**: 2025年12月15日
**議題**: 10年以上運用されているPHP + CakePHPシステムのリアーキテクチャにおける技術選定

---

## 1. 結論

### 言語・技術スタック
**PHP 8.x + Laravel（モジュラーモノリス）を採用**

### 設計手法・開発理論
**Clean Architecture + 戦術的DDD（ドメイン駆動設計）を採用**

---

## 2. 結論に対する簡単な説明

900万人が利用する10年以上のサービスにおいて、最も重要なのは「壊さないこと」である。言語変更は最も高コスト・高リスクな選択肢であり、開発速度低下の原因が言語にあるとは限らない。PHP 8.x + Laravelへの移行は既存チームのスキルを最大限活用でき、移行コスト・リスクが最も低い。Clean Architecture + DDDによる設計刷新で、言語を変えずとも保守性は大幅に向上する。モジュラーモノリスはマイクロサービスへの橋渡しとしても機能し、将来の拡張性も担保される。

---

## 3. 背景に記載がない前提

本議論では、以下の前提を置いて検討を行った：

| 項目 | 前提 |
|------|------|
| 現行PHPバージョン | PHP 7.x系（PHP 8.xへのアップグレードが技術的に可能） |
| テストカバレッジ | 十分ではない（移行前にテスト基盤整備が必要） |
| チーム構成 | PHP経験者が主体（10名前後と想定） |
| 移行予算・期間 | 2〜3年の投資が可能 |
| クラウド環境 | 何らかのクラウド環境を使用中（またはオンプレミス） |
| 開発速度低下の原因 | 言語ではなく設計・アーキテクチャに起因する可能性が高い |
| サービス継続性 | 移行中もサービス停止は許容されない |

---

## 4. どのようなことが検討されたかの詳細

### 4.1 各アドバイザーの視点

#### researcher（市場調査・技術トレンド）
- **調査内容**: 2024-2025年の技術トレンド、大規模サービスでの技術選定傾向、PHPからの移行先の選択肢
- **主な発見**:
  - TypeScript、Go、Pythonが急成長
  - 大規模サービスではマイクロサービスが標準的選択
  - Clean Architecture + DDDが保守性向上に有効
  - 日本の実例：i-plug社はFuelPHP→Laravelに4年かけて移行

#### pragmatist（実用的・実行計画）
- **推奨**: PHP 8.x + Laravel
- **理由**:
  - 既存チームが即戦力、学習期間ゼロ
  - 段階的移行が容易
  - 採用市場が広い
  - 「言語を変えるより設計を変えることに注力すべき」
- **提案した移行期間**: 現実的に2年、保守的に3年

#### critic（批判的視点）
- **核心的な指摘**:
  > 「開発速度低下の原因は、おそらく言語ではない」
- **警告したリスク**:
  - 言語変更による移行期間中の地獄（2〜3年、下手すれば5年以上）
  - 暗黙知の消失
  - 「保守性向上」の罠（言語を変えても解決しない問題が多い）
  - ビッグバン移行の誘惑
- **推奨**: まずPHP自体のアップグレードを検討すべき

#### advocate（ユーザー視点）
- **代弁した声**:
  > 「ユーザーは『PHPかどうか』なんて1ミリも気にしていません」
- **ユーザーにとっての重要事項**:
  1. 安定性（毎日使うものだから、動いて当たり前）
  2. 速度（朝の忙しい時間に待たされたくない）
  3. データの安全性（10年分の健康記録は私の財産）
  4. 使い勝手の維持（慣れた操作を変えないで）
- **結論**:
  > 「最高の技術選定とは『何も変わっていないように見えること』」

#### ideator（多角的アイデア提案）
- **提案した選択肢**:
  - モダンPHP（PHP 8.x + Laravel/Symfony）
  - Go（パフォーマンス重視）
  - Kotlin/Java（エンタープライズ安定性）
  - TypeScript/Node.js（フルスタック統一）
  - ハイブリッド戦略（適材適所）
- **現実的推奨**: モジュラーモノリス
- **移行戦略**: Strangler Figパターンを強く推奨

### 4.2 検討した選択肢の比較

| 選択肢 | メリット | デメリット | リスク | 支持アドバイザー |
|--------|----------|------------|--------|-----------------|
| **PHP 8.x + Laravel** | 既存スキル活用、移行コスト最小、段階的移行に最適 | PHP市場の将来不確実性、「新しさ」がない | 低 | pragmatist, critic, ideator |
| 言語変更（Go/TypeScript）+ マイクロサービス | 市場トレンドに合致、長期的な採用面メリット | 移行期間4年以上、チーム再教育、運用複雑化 | 高 | researcher（トレンドとして紹介） |
| 現行維持 + 部分的リファクタリング | 最小リスク、即座に着手可能 | 根本解決にならない、モチベーション維持困難 | 最小 | critic（暫定案として） |

### 4.3 合意に至った点

| 項目 | 全アドバイザーの合意 |
|------|---------------------|
| **段階的移行** | 一括移行は危険。Strangler Figパターンによる段階的移行が必須 |
| **設計の優先** | 言語変更より設計・アーキテクチャの改善が本質的 |
| **ユーザー影響最小化** | 移行中のサービス品質維持が絶対条件 |
| **現状把握の重要性** | まず現状の定量的測定から始めるべき |

### 4.4 採用理由

1. **リスク・リターンの最適バランス**: モジュラーモノリスは「低リスク × 中〜高リターン」の最適ポジション
2. **criticの指摘への回答**: 言語は変えずに設計を変えることで、開発速度低下の真因に対処
3. **advocateの要求への回答**: モジュラーモノリスは段階的移行との相性が最も良く、「何も変わっていないように見える」移行が実現可能
4. **将来への拡張性**: モジュール境界が明確であれば、将来必要に応じて特定モジュールのみを別言語で実装することも可能

### 4.5 推奨実行計画

```
フェーズ1: 現状把握と準備（3〜6ヶ月）
├── 現状の定量測定（コードメトリクス、テストカバレッジ、デプロイ頻度）
├── PHP 8.xへのアップグレード
└── テスト基盤の整備

フェーズ2: パイロット移行（6ヶ月〜1年）
├── 境界付けられたコンテキストの特定
├── 1〜2モジュールのパイロット移行
└── 学習と改善

フェーズ3: 本格移行（1〜2年）
├── 優先度に基づくモジュール移行
├── 継続的なモニタリング
└── 旧コードの段階的廃止
```

---

## 5. どのエージェントが使われたか

本議論では、以下の6つのエージェントを使用して多角的な検討を行った：

| エージェント | 役割 | 主な貢献 |
|-------------|------|----------|
| **researcher** | 市場調査・技術トレンド分析 | 2024-2025年の技術動向、大規模サービスの事例、PHPからの移行先選択肢の調査 |
| **pragmatist** | 実用的・実行計画の提案 | 具体的な移行計画、リソース見積もり、現実的なタイムラインの提示 |
| **critic** | 批判的視点・リスク指摘 | 言語変更のリスク、よくある失敗パターン、「保守性向上」の罠の指摘 |
| **advocate** | ユーザー視点での評価 | 900万人のユーザーの声を代弁、サービス品質維持の重要性を強調 |
| **ideator** | 多角的なアイデア提案 | 複数の技術選択肢とアーキテクチャパターンの比較、ハイブリッド戦略の提案 |
| **facilitator** | 意思決定の統合 | 各アドバイザーの意見を統合し、最終決定と根拠を文書化 |

### エージェント間の対話の流れ

```
┌─────────────────────────────────────────────────────────────┐
│  1. 並列で5つのエージェントが意見を提出                      │
│     - researcher: 市場調査結果                               │
│     - pragmatist: 実行計画                                   │
│     - critic: リスク指摘                                     │
│     - advocate: ユーザー視点                                 │
│     - ideator: 多角的アイデア                                │
│                                                              │
│  2. facilitatorが意見を統合                                  │
│     - 合意点の抽出                                           │
│     - 対立点の分析                                           │
│     - トレードオフの評価                                     │
│     - 最終決定の導出                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 付録: 見直し条件

以下の状況が発生した場合、本決定を再検討すべきである：

1. PHP 8.xへのアップグレードが技術的に不可能と判明した場合
2. パイロット移行で想定以上の困難が発生した場合
3. PHP人材の採用が著しく困難になった場合（市場環境の変化）
4. 事業要件の変化により、現行アーキテクチャでは対応不可能な機能が必要になった場合

---

**最終結論**: 言語は変えない。設計を変える。
